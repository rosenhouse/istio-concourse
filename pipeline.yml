groups:
- name: cf-integration
  jobs:
  - copilot-test
  - istio-release-test
- name: istio
  jobs:
  - upstream-istio
  - cache-test

resources:
- name: copilot
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/copilot

- name: istio-release
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/istio-release

- name: istio
  type: git
  source:
    branch: master
    uri: https://github.com/istio/istio

- name: istio-concourse
  type: git
  source:
    branch: master
    uri: https://github.com/rosenhouse/istio-concourse

jobs:
- name: copilot-test
  plan:
  - get: copilot
    trigger: true
  - task: test
    file: copilot/ci/test.yml

- name: istio-release-test
  plan:
  - get: istio-release
    trigger: true
  - task: test
    file: istio-release/ci/istio-tests.yml

- name: upstream-istio
  plan:
  - get: istio
    trigger: true
  - get: istio-release
    trigger: true
  - task: unit-test
    file: istio-release/ci/upstream-unit.yml

- name: cache-test
  plan:
  - get: istio-concourse
    trigger: true
  - get: istio
    trigger: true
  - task: dep-ensure
    file: istio-concourse/tasks/dep-ensure.yml
    input_mapping: {pre-ensure: istio}
    output_mapping: {post-ensure: istio-with-deps}
    params:
      GOPACKAGE: istio.io/istio
  - task: unit-test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: istio/ci
          tag: go1.9-k8s1.7.4
      inputs:
      - name: istio-with-deps
        path: go/src/istio.io/istio
      run:
        path: /bin/bash
        user: root
        args:
        - -c
        - |
          set -euxo pipefail
          export GOPATH=$PWD/go
          pwd
          ls -la
          cd go/src/istio.io/istio
          pwd
          ls -la
          go test ./pilot/model/...
